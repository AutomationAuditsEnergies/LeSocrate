<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Cours audio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>

  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }
  
    #send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  
audio {
  position: absolute;
  opacity: 0;
  width: 1px;
  height: 1px;
  pointer-events: none;
}

.visually-hidden {
  position: absolute !important;
  width: 1px !important;
  height: 1px !important;
  margin: -1px;
  padding: 0;
  overflow: hidden;
  clip: rect(0 0 0 0);
  white-space: nowrap;
  border: 0;
}

  
    /* ‚úÖ Redimensionnement anim√© quand le chat s'ouvre */
    .main-content {
      transition: all 0.4s ease;
    }
    
    .main-content.decale-gauche {
      transform: translateX(-8%);
    }

    /* Animation fade-in pour les messages */
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in {
      animation: fade-in 0.3s ease-out;
    }

    /* Scrollbar personnalis√©e */
    .scrollbar-thin::-webkit-scrollbar {
      width: 6px;
    }

    .scrollbar-thumb-gray-600::-webkit-scrollbar-thumb {
      background-color: #4b5563;
      border-radius: 3px;
    }

    .scrollbar-track-transparent::-webkit-scrollbar-track {
      background: transparent;
    }
  
    /* Lemon Milk */
    @font-face {
      font-family: 'Lemon Milk';
      src: url("{{ url_for('static', filename='fonts/LEMONMILK-Regular.otf') }}") format("opentype");
      font-weight: normal;
      font-style: normal;
    }
  
    .lemon-title {
      font-family: 'Lemon Milk', sans-serif;
      letter-spacing: 1px;
    }

    /* Transition fluide pour le changement d'image de fond */
    body {
      transition: background-image 0.7s ease-in-out;
    }

    /* Animation pour le compteur de participants */
    #participants-count {
      transition: transform 0.2s ease-out;
    }

    /* Notification de changement d'audio */
    .audio-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 20px 30px;
      border-radius: 12px;
      border: 2px solid #3b82f6;
      z-index: 1000;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    /* Animation "en train d'√©crire" */
.typing-indicator {
  background: rgba(55, 65, 81, 0.9);
  border: 1px solid rgba(75, 85, 99, 0.5);
  border-radius: 1rem;
  padding: 0.75rem 1rem;
  margin-bottom: 0.75rem;
  backdrop-filter: blur(8px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.typing-dots {
  display: flex;
  gap: 4px;
  align-items: center;
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background-color: #9ca3af;
  animation: typing-bounce 1.4s infinite ease-in-out;
}

.typing-dot:nth-child(1) { animation-delay: -0.32s; }
.typing-dot:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing-bounce {
  0%, 80%, 100% {
    transform: scale(0.8);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}

.professor-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6, #8b5cf6);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 12px;
  font-weight: bold;
  margin-right: 8px;
}

  </style>
  
</head>

<body class="flex flex-col h-full w-full bg-cover bg-center relative overflow-hidden"style="background-image: url('{{ url_for('static', filename='images/prof-avatar.jpg') }}');">
  <!-- Calque noir semi-transparent -->
  <div id="background-overlay" class="absolute inset-0 bg-red-900/30 z-0 transition-all duration-700"></div>

  <header class="relative z-10 w-full px-6 py-3">
    <div class="bg-black backdrop-blur-sm border border-white rounded-2xl px-4 py-3 flex items-center justify-between shadow-md">
      
      <!-- Partie utilisateur √† gauche -->
      <div class="flex items-center gap-3">
        <img src="{{ url_for('static', filename='images/user.webp') }}"
             alt="Photo utilisateur"
             class="w-10 h-10 rounded-full object-cover bg-gray-700" />

        <div class="text-sm text-white leading-tight">
          <div class="font-semibold">{{ prenom }} {{ nom }}</div>
          <div class="text-xs text-gray-400">Participant</div>
        </div>
      </div>

      <!-- Titre centr√© avec police Lemon Milk -->
      <div class="absolute left-1/2 transform -translate-x-1/2 text-white text-2xl lemon-title">
        Formation TP CRCD
      </div>

      <!-- Boutons √† droite -->
      <div class="flex items-center gap-3">
        <!-- Bouton Mode Sombre -->
        <button id="dark-mode-btn" class="flex items-center justify-center hover:opacity-90 transition">
          <svg xmlns="http://www.w3.org/2000/svg" 
               viewBox="0 0 24 24" 
               fill="currentColor" 
               class="w-8 h-8 text-indigo-400 drop-shadow-[0_0_3px_rgba(99,102,241,0.4)]">
            <path fill-rule="evenodd" d="M9.528 1.718a.75.75 0 0 1 .162.819A8.97 8.97 0 0 0 9 6a9 9 0 0 0 9 9 8.97 8.97 0 0 0 3.463-.69.75.75 0 0 1 .981.98 10.503 10.503 0 0 1-9.694 6.46c-5.799 0-10.5-4.7-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 0 1 .818.162Z" clip-rule="evenodd" />
          </svg>
        </button>

        <!-- Bouton Quitter -->
        <button onclick="window.location.href='/logout'" 
                class="flex items-center justify-center hover:opacity-90 transition">
          <svg xmlns="http://www.w3.org/2000/svg" 
               viewBox="0 0 24 24" 
               fill="currentColor" 
               class="w-8 h-8 text-purple-400 drop-shadow-[0_0_3px_rgba(147,51,234,0.4)]">
            <path fill-rule="evenodd" d="M7.5 3.75A1.5 1.5 0 0 0 6 5.25v13.5a1.5 1.5 0 0 0 1.5 1.5h6a1.5 1.5 0 0 0 1.5-1.5V15a.75.75 0 0 1 1.5 0v3.75a3 3 0 0 1-3 3h-6a3 3 0 0 1-3-3V5.25a3 3 0 0 1 3-3h6a3 3 0 0 1 3 3V9A.75.75 0 0 1 15 9V5.25a1.5 1.5 0 0 0-1.5-1.5h-6Zm5.03 4.72a.75.75 0 0 1 0 1.06l-1.72 1.72h10.94a.75.75 0 0 1 0 1.5H10.81l1.72 1.72a.75.75 0 1 1-1.06 1.06l-3-3a.75.75 0 0 1 0-1.06l3-3a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

    </div>
  </header>

  <!-- CONTENEUR PRINCIPAL ZOOM-LIKE -->
  <div class="flex flex-1 overflow-hidden">
    
    <!-- CONTENEUR PRINCIPAL POUR VID√âO + BARRE (nouveau wrapper) -->
    <div class="main-content flex flex-col flex-1">
      
      <!-- ZONE VID√âO PROFESSEUR -->
      <div class="flex-1 flex flex-col items-center justify-center p-4">
        <div id="video-zone"
        class="relative aspect-video w-full max-w-3xl rounded-xl overflow-hidden bg-gray-800 flex items-center justify-center border-2 border-white shadow-[0_0_12px_rgba(255,255,255,0.2)]">
          <!-- Pictogramme utilisateur centr√© -->
          <div class="flex flex-col items-center justify-center">
            <!-- Cercle blanc avec ic√¥ne utilisateur sombre -->
            <div class="w-32 h-32 rounded-full bg-white flex items-center justify-center">
              <!-- Vous pouvez remplacer ce SVG par votre propre image si vous pr√©f√©rez -->
              <svg xmlns="http://www.w3.org/2000/svg"
                   class="w-20 h-20 text-gray-800"
                   fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 
                         1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 
                         4v2h16v-2c0-2.66-5.33-4-8-4z"/>
              </svg>
            </div>
            <!-- L√©gende en dessous -->
            <span class="mt-3 text-white text-lg font-medium">Alain</span>
          </div>

          <!-- √âtiquette (optionnelle) "Prof. IA" toujours en bas √† gauche -->
          <div class="absolute bottom-2 left-2 bg-black/50 text-white text-sm px-3 py-1 rounded-lg">
            Professeur
          </div>

          <!-- Balise audio modifi√©e pour la synchronisation -->
          <audio id="audio" class="visually-hidden" controlslist="nodownload noplaybackrate noremoteplayback" disablepictureinpicture disableremoteplayback>
            {% if audio_filename %}
              <source src="{{ audio_filename }}" type="audio/mpeg">
            {% endif %}
          </audio>
        </div>


        
        <!-- Affichage du titre de l'audio en cours (optionnel) -->
        <div id="audio-title-display" class="text-white text-sm mt-2 text-center opacity-0">
          En cours : {{ audio_title if audio_title else 'Formation termin√©e' }}
        </div>
      </div>

      <!-- BARRE DE COMMANDES BASSE AM√âLIOR√âE -->
      <div id="command-bar" class="w-full flex justify-center pb-6 z-20">
        <div class="bg-black/80 border border-white rounded-2xl px-10 py-4 shadow-xl flex items-center gap-10 backdrop-blur-sm">
          
          <!-- Bouton "Mute" -->
          <button id="mute-btn" class="flex flex-col items-center hover:opacity-80 transition">
            <svg xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 24 24"
                 fill="currentColor"
                 class="w-8 h-8 text-pink-400 drop-shadow-[0_0_3px_rgba(255,105,180,0.4)]">
              <path d="M13.5 4.06c0-1.336-1.616-2.005-2.56-1.06l-4.5 4.5H4.508c-1.141 0-2.318.664-2.66 1.905A9.76 9.76 0 0 0 1.5 12c0 .898.121 1.768.35 2.595.341 1.24 1.518 1.905 2.659 1.905h1.93l4.5 4.5c.945.945 2.561.276 2.561-1.06V4.06ZM17.78 9.22a.75.75 0 1 0-1.06 1.06L18.44 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06l1.72-1.72 1.72 1.72a.75.75 0 1 0 1.06-1.06L20.56 12l1.72-1.72a.75.75 0 1 0-1.06-1.06l-1.72 1.72-1.72-1.72Z" />
            </svg>
            <span class="text-xs text-white mt-1">D√©sactiver le son</span>
          </button>

          <!-- Bouton "Participants" avec compteur -->
          <div id="participants-container" class="flex flex-col items-center hover:opacity-80 transition cursor-pointer">
            <div class="relative">
              <svg xmlns="http://www.w3.org/2000/svg"
                   viewBox="0 0 24 24"
                   fill="currentColor"
                   class="w-8 h-8 text-orange-400 drop-shadow-[0_0_3px_rgba(255,165,0,0.3)]">
                <path d="M4.5 6.375a4.125 4.125 0 1 1 8.25 0 4.125 4.125 0 0 1-8.25 0ZM14.25 8.625a3.375 3.375 0 1 1 6.75 0 3.375 3.375 0 0 1-6.75 0ZM1.5 19.125a7.125 7.125 0 0 1 14.25 0v.003l-.001.119a.75.75 0 0 1-.363.63 13.067 13.067 0 0 1-6.761 1.873c-2.472 0-4.786-.684-6.76-1.873a.75.75 0 0 1-.364-.63l-.001-.122ZM17.25 19.128l-.001.144a2.25 2.25 0 0 1-.233.96 10.088 10.088 0 0 0 5.06-1.01.75.75 0 0 0 .42-.643 4.875 4.875 0 0 0-6.957-4.611 8.586 8.586 0 0 1 1.71 5.157v.003Z" />
              </svg>
              <!-- Badge compteur -->
              <div id="participants-count" class="absolute -top-1 -right-1 bg-green-500 text-white text-xs font-bold rounded-full w-5 h-5 flex items-center justify-center shadow-lg hidden">
                1
              </div>
            </div>
            <span class="text-xs text-white mt-1">Participants</span>
          </div>

          <!-- Bouton "Open Chat" -->
          <button id="chat-toggle-btn" class="flex flex-col items-center hover:opacity-80 transition">
            <svg xmlns="http://www.w3.org/2000/svg"
                 viewBox="0 0 24 24"
                 fill="currentColor"
                 class="w-8 h-8 text-yellow-300 drop-shadow-[0_0_3px_rgba(253,224,71,0.4)]">
              <path fill-rule="evenodd"
                    d="M4.804 21.644A6.707 6.707 0 0 0 6 21.75a6.721 6.721 0 0 0 3.583-1.029c.774.182 1.584.279 2.417.279 5.322 0 9.75-3.97 9.75-9 0-5.03-4.428-9-9.75-9s-9.75 3.97-9.75 9c0 2.409 1.025 4.587 2.674 6.192.232.226.277.428.254.543a3.73 3.73 0 0 1-.814 1.686.75.75 0 0 0 .44 1.223ZM8.25 10.875a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25ZM10.875 12a1.125 1.125 0 1 1 2.25 0 1.125 1.125 0 0 1-2.25 0Zm4.875-1.125a1.125 1.125 0 1 0 0 2.25 1.125 1.125 0 0 0 0-2.25Z"
                    clip-rule="evenodd" />
            </svg>
            <span class="text-xs text-white mt-1">Ouvrir le tchat</span>
          </button>

        </div>
      </div>
      
    </div>

    <!-- ZONE CHAT LAT√âRAL FLOTTANT -->
    <div id="chat"
         style="display:none;"
         class="fixed top-24 right-6 bottom-6 w-96 bg-black border-2 border-white rounded-2xl flex flex-col shadow-2xl z-30 transform translate-x-full transition-transform duration-500 ease-out">
      
      <!-- En-t√™te du chat -->
      <div class="px-6 py-4 border-b border-white/30 flex-shrink-0 rounded-t-2xl">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div class="w-3 h-3 bg-green-400 rounded-full animate-pulse"></div>
            <h3 class="text-lg font-semibold text-white"> Chat en direct</h3>
          </div>
          <button id="close-chat-btn" class="text-white/60 hover:text-white transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
            </svg>
          </button>
        </div>
        <p class="text-xs text-gray-400 mt-1">Posez vos questions au professeur</p>
      </div>

      <!-- Zone des messages -->
      <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-3 scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-transparent min-h-0"></div>
      
      <!-- Zone de saisie -->
      <div class="p-4 border-t border-white/30 flex-shrink-0 rounded-b-2xl">
        <div class="flex gap-3">
          <div class="flex-1 relative">
            <input id="question"
                   placeholder="√âcris ta question..."
                   class="w-full px-4 py-3 bg-gray-800/80 border border-gray-600/50 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500/50 transition-all" />
          </div>
          <button id="send-btn"
                  disabled
                  class="px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white rounded-xl font-medium transition-all duration-200 transform hover:scale-105 disabled:hover:scale-100 shadow-lg">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

  </div>

  <!-- Champs cach√©s pour la synchronisation -->
  <input type="hidden" id="username" value="{{ prenom }} {{ nom }}">
  <input type="hidden" id="audio-id" value="{{ audio_id if audio_id else 0 }}">
  <input type="hidden" id="audio-filename" value="{{ audio_filename if audio_filename else '' }}">

  <script>
    // ‚úÖ VERSION ULTRA-SIMPLE - Ajoutez SEULEMENT ceci √† la fin de votre script

// 1. D√âSACTIVER SEULEMENT LES SYNCHRONISATIONS PROBL√âMATIQUES
console.log('üîß D√©sactivation des synchronisations uniquement');

// Attendre que tout soit charg√©
setTimeout(() => {
    // D√©sactiver les listeners de synchronisation si ils existent
    if (typeof socket !== 'undefined') {
        socket.off('sync_audio');
        console.log('‚úÖ sync_audio d√©sactiv√©');
    }
    
    // Arr√™ter seulement les intervalles de synchronisation
    if (typeof syncInterval !== 'undefined') {
        clearInterval(syncInterval);
        console.log('‚úÖ syncInterval arr√™t√©');
    }
    
    if (typeof audioMonitoringInterval !== 'undefined') {
        clearInterval(audioMonitoringInterval);
        console.log('‚úÖ audioMonitoringInterval arr√™t√©');
    }
}, 2000);

// 2. FONCTION POUR DIAGNOSTIQUER L'AUDIO
function debugAudio() {
    console.log('üîç DIAGNOSTIC AUDIO:');
    console.log('  - Audio existe:', !!audio);
    console.log('  - Audio src:', audio ? audio.src : 'N/A');
    console.log('  - Audio paused:', audio ? audio.paused : 'N/A');
    console.log('  - Audio currentTime:', audio ? audio.currentTime : 'N/A');
    console.log('  - Audio duration:', audio ? audio.duration : 'N/A');
    console.log('  - isAudioPlaying:', typeof isAudioPlaying !== 'undefined' ? isAudioPlaying : 'N/A');
    console.log('  - currentAudioId:', typeof currentAudioId !== 'undefined' ? currentAudioId : 'N/A');
}

// 3. FONCTION POUR FORCER LA LECTURE AUDIO
function forcePlayAudio() {
    if (audio && audio.src) {
        console.log('üîä Tentative de lecture forc√©e...');
        audio.play()
            .then(() => {
                console.log('‚úÖ Audio forc√© avec succ√®s');
                isAudioPlaying = true;
            })
            .catch(e => {
                console.error('‚ùå Erreur audio forc√©:', e);
                console.log('üîä Essayez de cliquer sur la page puis retapez forcePlayAudio()');
            });
    } else {
        console.log('‚ùå Pas d\'audio √† lire');
    }
}

// 4. FONCTION POUR RECHARGER L'AUDIO ACTUEL
function reloadCurrentAudio() {
    fetch('/api/cours-status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'playing') {
                console.log('üîÑ Rechargement audio:', data.audio_title);
                
                const audioInfo = COURS_PLAYLIST.find(a => a.id === data.audio_id);
                if (audioInfo && audio) {
                    const source = audio.querySelector('source');
                    source.src = audioInfo.filename;
                    audio.src = audioInfo.filename;
                    audio.load();
                    
                    audio.addEventListener('loadedmetadata', () => {
                        const targetTime = Math.min(data.offset, audio.duration);
                        audio.currentTime = targetTime;
                        console.log(`üìç Position: ${targetTime}s`);
                        
                        audio.play()
                            .then(() => {
                                console.log('‚úÖ Audio recharg√© et lanc√©');
                                isAudioPlaying = true;
                                currentAudioId = data.audio_id;
                            })
                            .catch(e => {
                                console.error('‚ùå Erreur lecture:', e);
                                console.log('üîä Interaction utilisateur requise');
                            });
                    }, { once: true });
                }
            } else {
                console.log('üìä Status cours:', data.status);
            }
        })
        .catch(e => console.error('‚ùå Erreur API:', e));
}

// 5. COMMANDES DISPONIBLES
window.debugAudio = debugAudio;
window.forcePlayAudio = forcePlayAudio;
window.reloadCurrentAudio = reloadCurrentAudio;

console.log('‚úÖ Outils de debug audio install√©s');
console.log('üí° Commandes disponibles:');
console.log('  - debugAudio() : Diagnostic complet');
console.log('  - forcePlayAudio() : Force la lecture');
console.log('  - reloadCurrentAudio() : Recharge l\'audio actuel');
    // Variables pour la synchronisation
    let currentAudioId = parseInt(document.getElementById("audio-id").value);
    let syncInterval;
    let isChangingAudio = false;
const COURS_PLAYLIST = [
    { id: 1, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/cours_9h00_9h45.mp3", duration: 2400, title: "Cours - Bloc 1 (9h00-9h45)", type: "cours" },
    { id: 2, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/qa_9h45_9h55.mp3", duration: 900, title: "Questions-R√©ponses IA (9h45-9h55)", type: "qa" },
    { id: 3, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/pause_9h55_10h05.mp3", duration: 600, title: "Pause (9h55-10h05)", type: "pause" },
    { id: 4, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/cours_10h05_10h50.mp3", duration: 2580, title: "Cours - Bloc 2 (10h05-10h50)", type: "cours" },
    { id: 5, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/qa_10h50_11h00.mp3", duration: 720, title: "Questions-R√©ponses IA (10h50-11h00)", type: "qa" },
    { id: 6, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/pause_11h00_11h05.mp3", duration: 300, title: "Pause (11h00-11h05)", type: "pause" },
    { id: 7, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/cours_11h05_12h00.mp3", duration: 2580, title: "Cours - Bloc 3 (11h05-12h00)", type: "cours" },
    { id: 8, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/qa_12h00_12h10.mp3", duration: 1020, title: "Questions-R√©ponses IA (12h00-12h10)", type: "qa" },
    { id: 9, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/pause_12h10_12h20.mp3", duration: 600, title: "Pause (12h10-12h20)", type: "pause" },
    { id: 10, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/cours_12h20_13h05.mp3", duration: 2400, title: "Cours - Bloc 4 (12h20-13h05)", type: "cours" },
    { id: 11, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/qa_13h05_13h15.mp3", duration: 900, title: "Questions-R√©ponses IA (13h05-13h15)", type: "qa" },
    { id: 12, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/pause_midi_13h15_14h45.mp3", duration: 5400, title: "Pause d√©jeuner (13h15-14h45)", type: "pause_midi" },
    { id: 13, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/cours_14h45_15h45.mp3", duration: 2700, title: "Cours - Bloc 5 (14h45-15h45)", type: "cours" },
    { id: 14, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/qa_15h45_16h00.mp3", duration: 1800, title: "Questions-R√©ponses IA (15h45-16h00)", type: "qa" },
    { id: 15, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/cours_16h00_17h00.mp3", duration: 2400, title: "Cours - Bloc 6 (16h00-17h00)", type: "cours" },
    { id: 16, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/qa_17h00_17h15.mp3", duration: 2100, title: "Questions-R√©ponses IA (17h00-17h15)", type: "qa" },
    { id: 17, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/pause_17h15_17h25.mp3", duration: 600, title: "Pause (17h15-17h25)", type: "pause" },
    { id: 18, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/cours_17h25_18h15.mp3", duration: 2460, title: "Cours - Bloc 7 (17h25-18h15)", type: "cours" },
    { id: 19, filename: "https://formationaudios-ebbgcnh0hbcxdjcq.z02.azurefd.net/audios/qa_18h15_18h30.mp3", duration: 1440, title: "Questions-R√©ponses IA (18h15-18h30)", type: "qa" }
];

    // Variable pour d√©tecter si le cours est termin√©
    const coursTermine = {{ cours_termine|tojson if cours_termine is defined else 'false' }};

    // R√©f√©rences DOM
    const audioOffset     = parseInt("{{ offset if offset else 0 }}");
    const videoZone       = document.getElementById("video-zone");
    const audio           = document.getElementById("audio");
    const chat            = document.getElementById("chat");
    const sendBtn         = document.getElementById("send-btn");
    const questionInput   = document.getElementById("question");
    const messagesDiv     = document.getElementById("messages");
    const username        = document.getElementById("username").value;
    const muteBtn         = document.getElementById("mute-btn");
    const participantsContainer = document.getElementById("participants-container");
    const participantsCount = document.getElementById("participants-count");
    let participantsOnline = 1;
    const chatToggleBtn   = document.getElementById("chat-toggle-btn");
    const mainContent     = document.querySelector(".main-content");
    const darkModeBtn     = document.getElementById("dark-mode-btn");
    const backgroundOverlay = document.getElementById("background-overlay");

    const socket = io();

    // ‚úÖ SYST√àME D'ACTIVATION AUDIO FIABLE ET TOUJOURS VISIBLE

// 1. VARIABLES GLOBALES
let audioActivated = false;
let activationButtonShown = false;

// 2. FONCTION pour afficher le bouton d'activation (toujours visible)
function showActivationButton() {
    // √âviter les doublons
    if (activationButtonShown) {
        console.log('üîä Bouton d\'activation d√©j√† affich√©');
        return;
    }
    
    // Supprimer tout bouton existant
    const existingBtn = document.getElementById('audio-activation-btn');
    if (existingBtn) {
        existingBtn.remove();
    }
    
    console.log('üîä Affichage du bouton d\'activation audio');
    
    const activationBtn = document.createElement('button');
    activationBtn.id = 'audio-activation-btn';
    activationBtn.innerHTML = `
        <div class="text-center">
            <div class="text-3xl mb-4">üîä</div>
            <div class="text-xl font-bold mb-2">Formation en cours</div>
            <div class="text-sm mb-4 opacity-80">Cliquez pour activer le son</div>
            <div class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                Activer l'audio
            </div>
        </div>
    `;
    
    // Style ultra-visible et fixe
    activationBtn.style.cssText = `
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        background: rgba(0, 0, 0, 0.95) !important;
        color: white !important;
        padding: 40px !important;
        border-radius: 20px !important;
        border: 3px solid #3b82f6 !important;
        z-index: 999999 !important;
        box-shadow: 0 0 50px rgba(59, 130, 246, 0.5) !important;
        font-family: Arial, sans-serif !important;
        cursor: pointer !important;
        min-width: 350px !important;
        text-align: center !important;
        backdrop-filter: blur(10px) !important;
    `;
    
    // Gestionnaire de clic
    activationBtn.onclick = async () => {
        console.log('üîä Bouton d\'activation cliqu√© !');
        
        try {
            // Changer l'apparence du bouton
            activationBtn.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl mb-4">‚è≥</div>
                    <div class="text-xl font-bold mb-2">Activation en cours...</div>
                    <div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>
                </div>
            `;
            
            // R√©cup√©rer l'√©tat actuel du cours
            const response = await fetch('/api/cours-status');
            const data = await response.json();
            
            console.log('üìä √âtat du cours:', data);
            
            if (data.status === 'playing') {
                // Trouver l'audio dans la playlist
                const audioInfo = COURS_PLAYLIST.find(a => a.id === data.audio_id);
                
                if (audioInfo) {
                    console.log('üéµ Configuration audio:', audioInfo.title);
                    
                    // Configurer l'audio
                    const source = audio.querySelector('source');
                    source.src = audioInfo.filename;
                    audio.src = audioInfo.filename;
                    audio.load();
                    
                    // Attendre que l'audio soit pr√™t
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => reject(new Error('Timeout')), 10000);
                        
                        const onReady = () => {
                            clearTimeout(timeout);
                            audio.removeEventListener('canplay', onReady);
                            audio.removeEventListener('error', onError);
                            resolve();
                        };
                        
                        const onError = (e) => {
                            clearTimeout(timeout);
                            audio.removeEventListener('canplay', onReady);
                            audio.removeEventListener('error', onError);
                            reject(e);
                        };
                        
                        audio.addEventListener('canplay', onReady);
                        audio.addEventListener('error', onError);
                    });
                    
                    // D√©finir la position
                    const targetTime = Math.min(data.offset, audio.duration);
                    audio.currentTime = targetTime;
                    
                    console.log(`üìç Position: ${targetTime}s / ${audio.duration}s`);
                    
                    // Attendre le seeking si n√©cessaire
                    if (targetTime > 0) {
                        await new Promise(resolve => {
                            const onSeeked = () => {
                                audio.removeEventListener('seeked', onSeeked);
                                resolve();
                            };
                            audio.addEventListener('seeked', onSeeked);
                        });
                    }
                    
                    // Lancer l'audio
                    await audio.play();
                    
                    console.log('‚úÖ Audio lanc√© avec succ√®s !');
                    
                    // Marquer comme activ√©
                    audioActivated = true;
                    isAudioPlaying = true;
                    currentAudioId = data.audio_id;
                    
                    // Supprimer le bouton
                    activationBtn.remove();
                    activationButtonShown = false;
                    
                    // Mettre √† jour l'interface
                    updateChatAvailability(audioInfo.type);
                    
                } else {
                    throw new Error('Audio non trouv√© dans la playlist');
                }
            } else {
                throw new Error(`Cours non disponible (status: ${data.status})`);
            }
            
        } catch (error) {
            console.error('‚ùå Erreur activation audio:', error);
            
            // Afficher l'erreur
            activationBtn.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl mb-4">‚ùå</div>
                    <div class="text-xl font-bold mb-2">Erreur</div>
                    <div class="text-sm mb-4">${error.message}</div>
                    <div class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        R√©essayer
                    </div>
                </div>
            `;
            
            // Permettre de r√©essayer
            setTimeout(() => {
                activationBtn.onclick = () => showActivationButton();
                activationBtn.click();
            }, 1000);
        }
    };
    
    // Ajouter au DOM
    document.body.appendChild(activationBtn);
    activationButtonShown = true;
    
    console.log('‚úÖ Bouton d\'activation ajout√© au DOM');
    
    // V√©rifier que le bouton est bien visible
    setTimeout(() => {
        const btnCheck = document.getElementById('audio-activation-btn');
        if (btnCheck) {
            console.log('‚úÖ Bouton confirm√© visible');
        } else {
            console.error('‚ùå Bouton introuvable apr√®s ajout !');
        }
    }, 100);
}

// 3. FONCTION pour cacher le bouton d'activation
function hideActivationButton() {
    const btn = document.getElementById('audio-activation-btn');
    if (btn) {
        btn.remove();
        activationButtonShown = false;
        console.log('üîä Bouton d\'activation supprim√©');
    }
}



// 6. FONCTION pour changer d'audio (simplifi√©e)
function changeAudio(filename, audioId, offset) {
    console.log(`üîÑ Changement audio: ${filename} (ID: ${audioId})`);
    
    // Trouver le type d'audio
    const audioInfo = COURS_PLAYLIST.find(a => a.id === audioId);
    if (audioInfo) {
        updateChatAvailability(audioInfo.type);
    }
    
    // Si l'audio n'est pas encore activ√©, juste afficher le bouton
    if (!audioActivated) {
        showActivationButton();
        return;
    }
    
    // Sinon, changer l'audio directement
    audio.pause();
    audio.currentTime = 0;
    
    const source = audio.querySelector('source');
    source.src = filename;
    audio.src = filename;
    audio.load();
    
    currentAudioId = audioId;
    
    audio.addEventListener('loadedmetadata', () => {
        const targetTime = Math.min(offset, audio.duration);
        audio.currentTime = targetTime;
        
        audio.addEventListener('seeked', () => {
            audio.play()
                .then(() => {
                    console.log('‚úÖ Audio chang√© et lanc√©');
                    isAudioPlaying = true;
                })
                .catch(e => {
                    console.error('‚ùå Erreur changement audio:', e);
                    showActivationButton();
                });
        }, { once: true });
    }, { once: true });
}

// 7. INITIALISATION au chargement de la page
window.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Initialisation du syst√®me audio');
    
    // Attendre un peu puis initialiser
    setTimeout(() => {
        initializeAudio();
    }, 1000);
});

// 8. COMMANDES DE DEBUG
window.showActivationButton = showActivationButton;
window.hideActivationButton = hideActivationButton;
window.resetAudioSystem = () => {
    audioActivated = false;
    activationButtonShown = false;
    hideActivationButton();
    showActivationButton();
};

console.log('‚úÖ Syst√®me d\'activation audio fiable install√©');
console.log('üí° Commandes disponibles:');
console.log('  - showActivationButton() : Affiche le bouton');
console.log('  - hideActivationButton() : Cache le bouton');
console.log('  - resetAudioSystem() : Reset complet');

    let isAudioPlaying = false;
    let lastSyncReceived = 0;

    let isMuted = false;
    let isDarkMode = false;
    let isProgressVisible = true;

    // ‚úÖ HANDLER PRINCIPAL : Synchronisation audio depuis le backend
    socket.on('sync_audio', (data) => {
      console.log('üîÑ Synchronisation re√ßue:', data);
      
      const { audio_id, audio_filename, offset, audio_changed } = data;
      
      // √âviter les traitements multiples rapproch√©s
      const now = Date.now();
      if (now - lastSyncReceived < 1000) {
        console.log('‚ö†Ô∏è Sync ignor√©e (trop r√©cente)');
        return;
      }
      lastSyncReceived = now;
      
      if (audio_changed || audio_id !== currentAudioId) {
        // CHANGEMENT D'AUDIO d√©tect√©
        console.log(`üö® CHANGEMENT AUDIO: ${currentAudioId} ‚Üí ${audio_id}`);
        changeAudio(audio_filename, audio_id, offset);
      } else {
        // M√äME AUDIO : juste resynchroniser la position
        const currentTime = audio.currentTime;
        const diff = Math.abs(offset - currentTime);
        
        if (diff > 3) {
          console.log(`üîÑ Resync position: ${currentTime.toFixed(1)}s ‚Üí ${offset}s`);
          audio.currentTime = offset;
        }
      }
    });

    // ‚úÖ HANDLER : Cours pas commenc√© ou termin√©
    socket.on('cours_not_started_or_finished', () => {
      console.log('üèÅ Cours pas commenc√© ou termin√©');
      
      // V√©rifier via API pour d√©terminer si c'est "waiting" ou "finished"
      fetch('/api/cours-status')
        .then(response => response.json())
        .then(data => {
          if (data.status === 'finished') {
            clearInterval(syncInterval);
            showCourseFinishedMessage();
          } else if (data.status === 'waiting') {
            // Rediriger vers page d'attente
            console.log('‚è≥ Redirection vers page d\'attente');
            window.location.href = '/video'; // Recharge la page qui g√©rera l'attente
          }
        })
        .catch(e => console.error('Erreur v√©rification statut:', e));
    });

    // ‚úÖ HANDLER : Gestion des erreurs de connexion
    socket.on('connect_error', (error) => {
      console.error('‚ùå Erreur connexion Socket:', error);
      
      // Fallback : utiliser la sync API si SocketIO √©choue
      if (!syncInterval) {
        console.log('üîÑ Fallback : activation sync API');
        syncInterval = setInterval(checkSync, 10000); // Plus long intervalle
      }
    });

    // ‚úÖ HANDLER : Reconnexion r√©ussie
    socket.on('connect', () => {
      console.log('‚úÖ Socket connect√©/reconnect√©');
      
      // Re-√©mettre la connexion utilisateur
      socket.emit('user_connected', { username });
      
      // Demander une synchronisation imm√©diate
      socket.emit('sync_request');
    });

    // Fonction pour g√©rer l'√©tat du chat selon le type d'audio
    function updateChatAvailability(audioType) {
      const chatToggleBtn = document.getElementById("chat-toggle-btn");
      const chatToggleText = chatToggleBtn.querySelector("span");
      
      if (audioType === "qa") {
        // Activer le chat pendant les Q&R
        chatToggleBtn.disabled = false;
        chatToggleBtn.classList.remove("opacity-50", "cursor-not-allowed");
        chatToggleBtn.classList.add("hover:opacity-80");
        chatToggleText.textContent = "Ouvrir le tchat";
        chatToggleBtn.title = "Posez vos questions √† l'IA";
      } else {
        // D√©sactiver le chat pendant cours/pauses
        chatToggleBtn.disabled = true;
        chatToggleBtn.classList.add("opacity-50", "cursor-not-allowed");
        chatToggleBtn.classList.remove("hover:opacity-80");
        chatToggleText.textContent = "Tchat indisponible";
        chatToggleBtn.title = "Le tchat n'est disponible que pendant les sessions Q&R";
        
        // Fermer le chat s'il est ouvert
        if (!chat.classList.contains("translate-x-full")) {
          chat.classList.add("translate-x-full");
          mainContent.classList.remove("decale-gauche");
          setTimeout(() => {
            chat.style.display = "none";
          }, 500);
        }
      }
    }

    // Au chargement de la page
    window.addEventListener("DOMContentLoaded", () => {
      // V√©rifier si le cours est termin√©
      if (coursTermine) {
        showCourseFinishedMessage();
        socket.emit('user_connected', { username });
        return;
      }

      // D√©terminer le type d'audio initial
      const initialAudio = COURS_PLAYLIST.find(audio => audio.id === currentAudioId);
      const initialType = initialAudio ? initialAudio.type : "cours";
      
      console.log(`üéØ Type d'audio initial: ${initialType} (ID: ${currentAudioId})`);
      
      // Configurer l'√©tat initial du chat
      updateChatAvailability(initialType);
      
      // D√©lai avant de lancer l'audio pour laisser le temps √† la synchronisation
      setTimeout(() => {
        initializeAudio();
      }, 1000);

      // √âmettre l'√©v√©nement de connexion
      console.log("√âmission de user_connected pour:", username);
      socket.emit('user_connected', { username });

      // Forcer plusieurs tentatives de connexion
      let connectionAttempts = 0;
      const maxAttempts = 5;
      
      const ensureConnection = () => {
        connectionAttempts++;
        console.log(`Tentative de connexion ${connectionAttempts}/${maxAttempts}`);
        socket.emit('user_connected', { username });
        
        if (connectionAttempts < maxAttempts) {
          setTimeout(ensureConnection, 2000);
        }
      };
      
      setTimeout(ensureConnection, 2000);

      // D√©marrer la v√©rification de synchronisation
      syncInterval = setInterval(checkSync, 30000);
      socket.emit('sync_request');

      // Gestionnaires d'√©v√©nements audio
      setupAudioEventListeners();
    });

    // Fonction pour initialiser l'audio
// ‚úÖ FONCTION UNIFI√âE - Remplace les deux versions existantes
function initializeAudio() {
    console.log("üéµ Initialisation audio...");
    console.log("AudioOffset:", audioOffset);
    console.log("CurrentAudioId:", currentAudioId);
    
    // Configurer les listeners audio basiques
    setupBasicAudioListeners();
    
    // √âmettre la connexion utilisateur
    socket.emit('user_connected', { username });
    
    videoZone.classList.remove("hidden");
    
    // Si on n'a pas de source audio valide, r√©cup√©rer via API
    if (!audio.src || audio.src === "" || audio.src.includes("undefined")) {
        console.warn("Source audio manquante, r√©cup√©ration via API...");
        
        fetch('/api/cours-status')
            .then(response => response.json())
            .then(data => {
                if (data.status === 'playing') {
                    console.log("√âtat du cours:", data);
                    const audioInfo = COURS_PLAYLIST.find(a => a.id === data.audio_id);
                    if (audioInfo) {
                        const source = audio.querySelector('source');
                        source.src = audioInfo.filename;
                        audio.src = audioInfo.filename;
                        audio.load();
                        
                        currentAudioId = data.audio_id;
                        
                        // Attendre que les m√©tadonn√©es soient charg√©es
                        audio.addEventListener('loadedmetadata', () => {
                            console.log(`M√©tadonn√©es charg√©es, dur√©e: ${audio.duration}s`);
                            const targetTime = Math.min(data.offset, audio.duration);
                            
                            // D√©finir le temps
                            audio.currentTime = targetTime;
                            console.log(`Position d√©finie √† ${targetTime}s`);
                            
                            // Mettre √† jour l'interface
                            updateChatAvailability(audioInfo.type);
                            
                            // Attendre un court instant pour que le seeking se fasse
                            setTimeout(() => {
                                if (!isAudioPlaying) {
                                    isAudioPlaying = true;
                                    audio.play()
                                        .then(() => {
                                            console.log("‚úÖ Audio initial d√©marr√©");
                                            audioActivated = true;
                                        })
                                        .catch(e => {
                                            console.log("Lecture bloqu√©e, affichage du bouton:", e);
                                            isAudioPlaying = false;
                                            showActivationButton();
                                        });
                                }
                            }, 100);
                        }, { once: true });
                    } else {
                        console.warn("Audio non trouv√© dans la playlist");
                        showActivationButton();
                    }
                } else if (data.status === 'finished') {
                    console.log("Cours termin√©");
                    showCourseFinishedMessage();
                } else {
                    console.log("Cours en attente");
                    showActivationButton();
                }
            })
            .catch(e => {
                console.error("Erreur API:", e);
                showActivationButton();
            });
    } else {
        // Si on a d√©j√† une source, utiliser l'offset fourni
        if (audioOffset >= 0 && !isNaN(audioOffset)) {
            if (audio.readyState >= 2) {
                // Si les m√©tadonn√©es sont d√©j√† charg√©es
                const targetTime = Math.min(audioOffset, audio.duration || audioOffset);
                audio.currentTime = targetTime;
                console.log(`Audio d√©j√† pr√™t, position: ${targetTime}s`);
                
                if (!isAudioPlaying) {
                    isAudioPlaying = true;
                    audio.play()
                        .then(() => {
                            console.log("‚úÖ Audio d√©marr√©");
                            audioActivated = true;
                        })
                        .catch(e => {
                            console.log("Lecture bloqu√©e:", e);
                            isAudioPlaying = false;
                            showActivationButton();
                        });
                }
            } else {
                // Attendre les m√©tadonn√©es
                audio.addEventListener('loadedmetadata', () => {
                    const targetTime = Math.min(audioOffset, audio.duration);
                    audio.currentTime = targetTime;
                    console.log(`Position d√©finie √† ${targetTime}s / ${audio.duration}s`);
                    
                    setTimeout(() => {
                        if (!isAudioPlaying) {
                            isAudioPlaying = true;
                            audio.play()
                                .then(() => {
                                    console.log("‚úÖ Audio d√©marr√© apr√®s m√©tadonn√©es");
                                    audioActivated = true;
                                })
                                .catch(e => {
                                    console.log("Lecture bloqu√©e:", e);
                                    isAudioPlaying = false;
                                    showActivationButton();
                                });
                        }
                    }, 100);
                }, { once: true });
            }
        } else {
            // Pas d'offset valide, afficher le bouton
            showActivationButton();
        }
    }
}

// ‚úÖ FONCTION AM√âLIOR√âE - Remplace setupBasicAudioListeners()
function setupBasicAudioListeners() {
    audio.addEventListener('ended', () => {
        console.log('üèÅ Audio termin√©');
        isAudioPlaying = false;
        
        // Afficher le bouton pour le prochain audio
        if (audioActivated) {
            showActivationButton();
        }
    });
    
    audio.addEventListener('error', (e) => {
        console.error('‚ùå Erreur audio:', e);
        isAudioPlaying = false;
        
        // Afficher le bouton en cas d'erreur
        showActivationButton();
    });
    
    audio.addEventListener('pause', () => {
        console.log('‚è∏Ô∏è Audio en pause');
        isAudioPlaying = false;
    });
    
    audio.addEventListener('play', () => {
        console.log('‚ñ∂Ô∏è Audio en lecture');
        isAudioPlaying = true;
    });
    
    audio.addEventListener('loadstart', () => {
        console.log('üîÑ D√©but chargement audio');
    });

    audio.addEventListener('canplay', () => {
        console.log('‚úÖ Audio pr√™t √† √™tre jou√©');
    });
}

// ‚úÖ FONCTION AM√âLIOR√âE - Version plus robuste de showActivationButton()
function showActivationButton() {
    // √âviter les doublons
    if (activationButtonShown) {
        console.log('üîä Bouton d\'activation d√©j√† affich√©');
        return;
    }
    
    // Supprimer tout bouton existant
    const existingBtn = document.getElementById('audio-activation-btn');
    if (existingBtn) {
        existingBtn.remove();
    }
    
    console.log('üîä Affichage du bouton d\'activation audio');
    
    const activationBtn = document.createElement('button');
    activationBtn.id = 'audio-activation-btn';
    activationBtn.innerHTML = `
        <div class="text-center">
            <div class="text-3xl mb-4">üîä</div>
            <div class="text-xl font-bold mb-2">Formation en cours</div>
            <div class="text-sm mb-4 opacity-80">Cliquez pour activer le son</div>
            <div class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition-colors">
                Activer l'audio
            </div>
        </div>
    `;
    
    // Style ultra-visible et fixe
    activationBtn.style.cssText = `
        position: fixed !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        background: rgba(0, 0, 0, 0.95) !important;
        color: white !important;
        padding: 40px !important;
        border-radius: 20px !important;
        border: 3px solid #3b82f6 !important;
        z-index: 999999 !important;
        box-shadow: 0 0 50px rgba(59, 130, 246, 0.5) !important;
        font-family: Arial, sans-serif !important;
        cursor: pointer !important;
        min-width: 350px !important;
        text-align: center !important;
        backdrop-filter: blur(10px) !important;
    `;
    
    // Gestionnaire de clic
    activationBtn.onclick = async () => {
        console.log('üîä Bouton d\'activation cliqu√© !');
        
        try {
            // Changer l'apparence du bouton
            activationBtn.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl mb-4">‚è≥</div>
                    <div class="text-xl font-bold mb-2">Activation en cours...</div>
                    <div class="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto"></div>
                </div>
            `;
            
            // R√©cup√©rer l'√©tat actuel du cours
            const response = await fetch('/api/cours-status');
            const data = await response.json();
            
            console.log('üìä √âtat du cours:', data);
            
            if (data.status === 'playing') {
                // Trouver l'audio dans la playlist
                const audioInfo = COURS_PLAYLIST.find(a => a.id === data.audio_id);
                
                if (audioInfo) {
                    console.log('üéµ Configuration audio:', audioInfo.title);
                    
                    // Configurer l'audio
                    const source = audio.querySelector('source');
                    source.src = audioInfo.filename;
                    audio.src = audioInfo.filename;
                    audio.load();
                    
                    // Attendre que l'audio soit pr√™t
                    await new Promise((resolve, reject) => {
                        const timeout = setTimeout(() => reject(new Error('Timeout')), 10000);
                        
                        const onReady = () => {
                            clearTimeout(timeout);
                            audio.removeEventListener('canplay', onReady);
                            audio.removeEventListener('error', onError);
                            resolve();
                        };
                        
                        const onError = (e) => {
                            clearTimeout(timeout);
                            audio.removeEventListener('canplay', onReady);
                            audio.removeEventListener('error', onError);
                            reject(e);
                        };
                        
                        audio.addEventListener('canplay', onReady);
                        audio.addEventListener('error', onError);
                    });
                    
                    // D√©finir la position
                    const targetTime = Math.min(data.offset, audio.duration);
                    audio.currentTime = targetTime;
                    
                    console.log(`üìç Position: ${targetTime}s / ${audio.duration}s`);
                    
                    // Attendre le seeking si n√©cessaire
                    if (targetTime > 0) {
                        await new Promise(resolve => {
                            const onSeeked = () => {
                                audio.removeEventListener('seeked', onSeeked);
                                resolve();
                            };
                            audio.addEventListener('seeked', onSeeked);
                        });
                    }
                    
                    // Lancer l'audio
                    await audio.play();
                    
                    console.log('‚úÖ Audio lanc√© avec succ√®s !');
                    
                    // Marquer comme activ√©
                    audioActivated = true;
                    isAudioPlaying = true;
                    currentAudioId = data.audio_id;
                    
                    // Supprimer le bouton
                    activationBtn.remove();
                    activationButtonShown = false;
                    
                    // Mettre √† jour l'interface
                    updateChatAvailability(audioInfo.type);
                    
                } else {
                    throw new Error('Audio non trouv√© dans la playlist');
                }
            } else {
                throw new Error(`Cours non disponible (status: ${data.status})`);
            }
            
        } catch (error) {
            console.error('‚ùå Erreur activation audio:', error);
            
            // Afficher l'erreur
            activationBtn.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl mb-4">‚ùå</div>
                    <div class="text-xl font-bold mb-2">Erreur</div>
                    <div class="text-sm mb-4">${error.message}</div>
                    <div class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-medium transition-colors">
                        R√©essayer
                    </div>
                </div>
            `;
            
            // Permettre de r√©essayer
            setTimeout(() => {
                activationBtn.onclick = () => showActivationButton();
                activationBtn.click();
            }, 1000);
        }
    };
    
    // Ajouter au DOM
    document.body.appendChild(activationBtn);
    activationButtonShown = true;
    
    console.log('‚úÖ Bouton d\'activation ajout√© au DOM');
}

// ‚úÖ AM√âLIORER setupAudioEventListeners() avec gestion d'erreur pour re-sync
function setupAudioEventListeners() {
  audio.addEventListener("error", (e) => {
    console.error("Erreur audio:", e);
    isAudioPlaying = false;  // ‚úÖ Reset √©tat
    
    // ‚úÖ NOUVEAU : √âmettre l'erreur au backend pour re-sync
    socket.emit('audio_playback_error', { 
      error: e.message || 'Audio error',
      audio_id: currentAudioId,
      current_time: audio.currentTime
    });
    
    setTimeout(() => {
      console.log("Tentative de rechargement de l'audio...");
      audio.load();
    }, 2000);
  });

  audio.addEventListener("canplay", () => {
    console.log("Audio pr√™t √† √™tre jou√©");
  });

  // ‚úÖ NOUVEAU : √âv√©nement quand l'audio se termine
  audio.addEventListener("ended", () => {
    console.log("Audio termin√©");
    isAudioPlaying = false;
  });

  // ‚úÖ NOUVEAU : √âv√©nement quand l'audio est en pause
  audio.addEventListener("pause", () => {
    console.log("Audio en pause");
    isAudioPlaying = false;
  });

  // ‚úÖ NOUVEAU : √âv√©nement quand l'audio d√©marre
  audio.addEventListener("play", () => {
    console.log("Audio en lecture");
    isAudioPlaying = true;
  });
}
    // Fonction pour d√©bloquer l'audio
    function showAudioUnlockButton() {
      const existingBtn = document.getElementById('unlock-audio-btn');
      if (existingBtn) existingBtn.remove();
      
      const unlockBtn = document.createElement('button');
      unlockBtn.id = 'unlock-audio-btn';
      unlockBtn.innerHTML = `
        <div class="flex items-center gap-2">
          <svg class="w-5 h-5 text-white/70" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
          </svg>
          <span class="text-sm text-white/90">Cliquez pour activer l'audio</span>
        </div>
      `;

      unlockBtn.className = `
        fixed bottom-6 right-6
        bg-black/60 hover:bg-black/80
        backdrop-blur-md
        text-white px-4 py-3 rounded-lg
        font-medium z-[9999] 
        shadow-lg border border-white/10
        transition-all duration-300 hover:scale-105 cursor-pointer
        hover:shadow-xl
      `.replace(/\s+/g, ' ').trim();

      unlockBtn.onclick = () => {
        console.log("Tentative de d√©blocage audio par l'utilisateur...");
        
        if (!audio.src || audio.src === "") {
          console.log("Pas de source, r√©cup√©ration via API...");
          fetch('/api/cours-status')
            .then(response => response.json())
            .then(data => {
              if (data.status === 'playing') {
                const source = audio.querySelector('source');
                const audioInfo = COURS_PLAYLIST.find(a => a.id === data.audio_id);
                source.src = audioInfo ? audioInfo.filename : data.audio_filename;
                audio.load();
                
                audio.addEventListener('loadeddata', () => {
                  audio.currentTime = data.offset;
                  audio.play().then(() => {
                    unlockBtn.remove();
                    console.log("‚úÖ Audio d√©bloqu√© et d√©marr√© avec succ√®s");
                  });
                }, { once: true });
              }
            });
        } else {
          audio.play().then(() => {
            unlockBtn.remove();
            console.log("‚úÖ Audio d√©bloqu√© et d√©marr√© avec succ√®s");
          }).catch(e => {
            console.error("‚ùå √âchec du d√©blocage:", e);
            unlockBtn.innerHTML = `
              <div class="text-center">
                <div class="text-lg font-bold">‚ùå Erreur</div>
                <div class="text-sm">Impossible de d√©marrer l'audio</div>
              </div>
            `;
          });
        }
      };
      
      document.body.appendChild(unlockBtn);
      console.log("üîä Bouton d'activation audio affich√© - L'utilisateur doit cliquer pour d√©bloquer");
    }


    // Fonction pour v√©rifier la synchronisation
    async function checkSync() {
      if (isChangingAudio) return;
      
      try {
        const response = await fetch('/api/cours-status');
        const data = await response.json();
        
        if (data.status === 'finished') {
          clearInterval(syncInterval);
          showCourseFinishedMessage();
        } else if (data.status === 'playing') {
          if (data.audio_id !== currentAudioId) {
            changeAudio(data.audio_filename, data.audio_id, data.offset);
          } else {
            const expectedTime = data.offset;
            const currentTime = audio.currentTime;
            const diff = Math.abs(expectedTime - currentTime);
            
            if (diff > 3) {
              audio.currentTime = expectedTime;
              console.log(`Resynchronisation: ${currentTime} -> ${expectedTime}`);
            }
          }
        }
      } catch (error) {
        console.error('Erreur de synchronisation:', error);
      }
    }

 // ‚úÖ AM√âLIOREZ votre fonction changeAudio() pour √©viter les AbortError :

function changeAudio(filename, audioId, offset) {
  // Protection contre changements concurrents
  if (isChangingAudio) {
    console.log('‚ö†Ô∏è Changement audio d√©j√† en cours, ignor√©');
    return;
  }
  
  isChangingAudio = true;
  isAudioPlaying = false;
  
  console.log(`üîÑ Changement d'audio: ${filename} (ID: ${audioId}, Offset: ${offset}s)`);
  
  // Type d'audio et chat
  const currentAudio = COURS_PLAYLIST.find(audio => audio.id === audioId);
  const audioType = currentAudio ? currentAudio.type : "cours";
  updateChatAvailability(audioType);
  
  // ‚úÖ AM√âLIORATION : Arr√™t plus propre pour √©viter AbortError
  const stopCurrentAudio = async () => {
    try {
      // Si l'audio est en cours de lecture, l'arr√™ter proprement
      if (!audio.paused) {
        audio.pause();
        // Attendre un peu pour que la pause soit effective
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      // R√©initialiser la position
      audio.currentTime = 0;
      
      // Vider les sources
      audio.src = '';
      const source = audio.querySelector('source');
      if (source) {
        source.src = '';
      }
      
      // Forcer le d√©chargement
      audio.load();
      
      // Attendre que le d√©chargement soit effectif
      await new Promise(resolve => setTimeout(resolve, 200));
      
      console.log('üßπ Audio arr√™t√© et nettoy√© proprement');
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Erreur lors de l\'arr√™t audio:', error);
    }
  };
  
  // ‚úÖ Arr√™t asynchrone de l'audio
  stopCurrentAudio().then(() => {
    // D√©finir la nouvelle source
    let newSource;
    if (filename.startsWith('https://')) {
      newSource = filename;
    } else {
      const audioInfo = COURS_PLAYLIST.find(a => a.id === audioId);
      newSource = audioInfo ? audioInfo.filename : filename;
    }
    
    console.log(`üîó Nouvelle source: ${newSource.split('/').pop()}`);
    
    // Charger la nouvelle source
    const source = audio.querySelector('source');
    source.src = newSource;
    audio.src = newSource;
    audio.load();
    
    // Mettre √† jour l'ID
    currentAudioId = audioId;
    
    // ‚úÖ AM√âLIORATION : Gestion plus robuste du chargement
    let hasLoaded = false;
    let loadTimeout;
    
    const handleLoadComplete = async () => {
      if (hasLoaded) return;
      hasLoaded = true;
      
      // Nettoyer le timeout
      if (loadTimeout) {
        clearTimeout(loadTimeout);
      }
      
      console.log(`‚úÖ Audio charg√©, dur√©e: ${audio.duration}s`);
      
      try {
        // D√©finir la position
        const targetTime = Math.min(offset, audio.duration);
        audio.currentTime = targetTime;
        
        console.log(`üìç Position d√©finie: ${targetTime}s`);
        
        // Attendre le seeking si n√©cessaire
        if (targetTime > 0) {
          await new Promise(resolve => {
            const onSeeked = () => {
              audio.removeEventListener('seeked', onSeeked);
              resolve();
            };
            audio.addEventListener('seeked', onSeeked);
          });
        }
        
        // ‚úÖ AM√âLIORATION : Lecture avec gestion d'erreur
        if (!isAudioPlaying) {
          isAudioPlaying = true;
          
          try {
            await audio.play();
            console.log("‚úÖ Audio d√©marr√© avec succ√®s");
            isChangingAudio = false;
          } catch (playError) {
            console.warn("‚ùå Erreur lecture:", playError);
            isAudioPlaying = false;
            isChangingAudio = false;
            
            // Gestion sp√©cifique des erreurs
            if (playError.name === 'AbortError') {
              console.log('üîÑ AbortError, retry dans 1 seconde');
              setTimeout(() => {
                socket.emit('sync_request');
              }, 1000);
            } else {
              showAudioUnlockButton();
            }
          }
        } else {
          isChangingAudio = false;
        }
        
      } catch (error) {
        console.error('‚ùå Erreur lors du setup audio:', error);
        isAudioPlaying = false;
        isChangingAudio = false;
        showAudioUnlockButton();
      }
    };
    
    // √âcouter les √©v√©nements de chargement
    audio.addEventListener('loadedmetadata', handleLoadComplete, { once: true });
    audio.addEventListener('canplaythrough', handleLoadComplete, { once: true });
    
    // Timeout de s√©curit√©
    loadTimeout = setTimeout(() => {
      if (!hasLoaded) {
        console.warn('‚ö†Ô∏è Timeout chargement audio, retry...');
        hasLoaded = true;
        
        // Retry avec une approche plus simple
        audio.addEventListener('canplay', async () => {
          try {
            const targetTime = Math.min(offset, audio.duration || offset);
            audio.currentTime = targetTime;
            
            if (!isAudioPlaying) {
              isAudioPlaying = true;
              await audio.play();
              console.log("‚úÖ Audio d√©marr√© apr√®s timeout");
              isChangingAudio = false;
            }
          } catch (error) {
            console.error('‚ùå Retry √©chou√©:', error);
            isAudioPlaying = false;
            isChangingAudio = false;
            showAudioUnlockButton();
          }
        }, { once: true });
      }
    }, 8000);
    
  }).catch(error => {
    console.error('‚ùå Erreur dans stopCurrentAudio:', error);
    isChangingAudio = false;
    showAudioUnlockButton();
  });
}

    // Fonction pour afficher le message de fin de cours
// NOUVELLE VERSION AVEC D√âCONNEXION AUTO
function showCourseFinishedMessage() {
  const videoZone = document.getElementById("video-zone");
  videoZone.innerHTML = `
    <div class="flex flex-col items-center justify-center text-white h-full">
      <div class="text-6xl mb-6">üéì</div>
      <h2 class="text-3xl font-bold mb-4">Cours termin√© !</h2>
      <p class="text-lg mb-6 text-center opacity-80">
        Merci d'avoir particip√© au premier cours de cette formation.
      </p>
      <div class="bg-yellow-900/50 border border-yellow-500 rounded-lg p-4 mb-6">
        <p class="text-yellow-200 text-center">
          D√©connexion automatique dans <span id="countdown">30</span> secondes
        </p>
      </div>
      <div class="space-y-4">
        <button onclick="window.location.href='/logout'" 
                class="bg-blue-600 hover:bg-blue-700 px-6 py-3 rounded-lg font-medium transition">
          Se d√©connecter maintenant
        </button>
      </div>
    </div>
  `;
  
  const audioTitleDisplay = document.getElementById('audio-title-display');
  if (audioTitleDisplay) {
    audioTitleDisplay.textContent = "Formation termin√©e";
  }
  
  // ‚úÖ NOUVEAU : D√©marrer le compte √† rebours
  startLogoutCountdown();
}

    // Fonction Mute / Unmute
    muteBtn.addEventListener("click", () => {
      isMuted = !isMuted;
      audio.muted = isMuted;
      muteBtn.querySelector("span:last-child").textContent = isMuted ? "R√©activer le son" : "D√©sactiver le son";
    });

    // Fonction Mode Sombre
    darkModeBtn.addEventListener("click", () => {
      isDarkMode = !isDarkMode;
      
      if (isDarkMode) {
        document.body.style.backgroundImage = "url('{{ url_for('static', filename='images/wallpaper.jpg') }}')";
        backgroundOverlay.style.background = "rgba(0, 0, 0, 0.5)";
      } else {
        document.body.style.backgroundImage = "url('{{ url_for('static', filename='images/prof-avatar.jpg') }}')";
        backgroundOverlay.style.background = "";
        backgroundOverlay.className = "absolute inset-0 bg-red-900/30 z-0 transition-all duration-700";
      }
    });

    // Toggle du chat avec v√©rification d'√©tat
    chatToggleBtn.addEventListener("click", () => {
      if (chatToggleBtn.disabled) {
        console.log("üí¨ Chat indisponible pendant cette session");
        return;
      }
      
      const isChatOpen = !chat.classList.contains("translate-x-full");

      if (isChatOpen) {
        chat.classList.add("translate-x-full");
        mainContent.classList.remove("decale-gauche");
        setTimeout(() => {
          chat.style.display = "none";
        }, 500);
      } else {
        chat.style.display = "flex";
        setTimeout(() => {
          chat.classList.remove("translate-x-full");
          mainContent.classList.add("decale-gauche");
        }, 10);
      }
    });

    // Bouton de fermeture du chat
    document.getElementById("close-chat-btn").addEventListener("click", () => {
      chat.classList.add("translate-x-full");
      mainContent.classList.remove("decale-gauche");
      setTimeout(() => {
        chat.style.display = "none";
      }, 500);
    });

    // Activation du bouton d'envoi
    questionInput.addEventListener('input', () => {
      sendBtn.disabled = questionInput.value.trim() === '';
    });

    // Envoi de la question
// Envoi de la question
function sendQuestion() {
  const question = questionInput.value.trim();
  if (!question) return;
  
  // ‚úÖ AJOUTER : Afficher IMM√âDIATEMENT mon message
  addMessage(username, question, new Date().toLocaleTimeString());
  
  // ‚úÖ AJOUTER : Afficher l'animation "est en train d'√©crire"
  showTypingIndicator();
  
  socket.emit('send_question', { username, question });
  questionInput.value = '';
  sendBtn.disabled = true;
}

    sendBtn.addEventListener('click', sendQuestion);
    questionInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !sendBtn.disabled) {
        e.preventDefault();
        sendQuestion();
      }
    });

    // Affichage d'un nouveau message dans le chat
    function addMessage(user, msg, time) {
      const isMine = (user === username);
      const alignment = isMine ? 'items-end self-end' : 'items-start self-start';
      const bubbleColor = isMine 
        ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white' 
        : 'bg-gray-800/80 text-white border border-gray-600/30';
      const nameColor = isMine ? 'text-blue-100' : 'text-gray-300';
      const timeColor = isMine ? 'text-blue-200' : 'text-gray-500';

      const newMessage = document.createElement('div');
      newMessage.className = `flex flex-col ${alignment} max-w-[85%] animate-fade-in`;
      newMessage.innerHTML = `
        <div class="text-xs ${timeColor} mb-1 px-1">${time}</div>
        <div class="px-4 py-3 rounded-2xl ${bubbleColor} shadow-lg backdrop-blur-sm">
          <span class="text-xs ${nameColor} block font-medium mb-1">${user}</span>
          <span class="text-sm whitespace-pre-wrap leading-relaxed">${msg}</span>
        </div>
      `;
      messagesDiv.appendChild(newMessage);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

// R√©ception des messages
// NOUVEAU CODE - SOLUTION COMPL√àTE
socket.on('receive_question', (data) => {
  console.log("=== MESSAGE RE√áU ===");
  console.log("Username:", data.username);
  console.log("Question:", data.question);
  console.log("Mon username:", username);
  
  // Ne pas afficher mes propres messages (ils sont d√©j√† affich√©s)
  if (data.username === username) {
    console.log("üí¨ Mon propre message ignor√© (d√©j√† affich√©)");
    return;
  }
  
  // Afficher les messages du Professeur
  if (data.username === "Professeur" || data.username === "Alain") {
    console.log("‚úÖ Message du professeur");
    hideTypingIndicator();
    addMessage("Professeur", data.question, data.timestamp);
    return;
  }
  
  // Afficher les messages des autres participants
  console.log("üë• Message d'un autre participant");
  addMessage(data.username, data.question, data.timestamp);
});

    socket.on("receive_audio", (data) => {
      const audioB64 = data.audio_b64;
      const byteArray = Uint8Array.from(atob(audioB64), c => c.charCodeAt(0));
      const audioBlob  = new Blob([byteArray], { type: "audio/mp3" });
      const audioUrl   = URL.createObjectURL(audioBlob);

      const newMessage = document.createElement('div');
      newMessage.className = "flex flex-col items-start self-start max-w-[85%] animate-fade-in";
      newMessage.innerHTML = `
        <div class="text-xs text-gray-500 mb-1 px-1">${new Date().toLocaleTimeString()}</div>
        <div class="px-4 py-3 rounded-2xl bg-gray-800/80 border border-gray-600/30 shadow-lg backdrop-blur-sm">
          <span class="text-xs text-gray-300 block font-medium mb-2">ü§ñ Prof IA</span>
          <audio controls class="w-full mt-2 rounded-lg">
            <source src="${audioUrl}" type="audio/mp3">
            Votre navigateur ne supporte pas l'audio.
          </audio>
        </div>
      `;
      messagesDiv.appendChild(newMessage);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      const audioClient = new Audio(audioUrl);
      audioClient.play().catch(e => console.log("Erreur lecture audio:", e));
    });

    // Fonction pour d√©bloquer l'audio
  // Fonction pour d√©bloquer l'audio
// ‚úÖ AM√âLIORATION MINEURE de unlockAudio() :
function unlockAudio() {
  console.log("üîä Tentative de d√©blocage audio...");
  
  document.getElementById('unlock-audio-btn').style.display = 'none';
  
  fetch('/api/cours-status')
    .then(response => response.json())
    .then(data => {
      if (data.status === 'playing') {
        const audioInfo = COURS_PLAYLIST.find(a => a.id === data.audio_id);
        
        if (!audio.src || audio.src === "" || audio.src.includes("undefined")) {
          // Charger la source si elle n'existe pas
          const source = audio.querySelector('source');
          source.src = audioInfo ? audioInfo.filename : data.audio_filename;
          audio.load();
          
          audio.addEventListener('loadedmetadata', () => {
            const targetTime = Math.min(data.offset, audio.duration);
            audio.currentTime = targetTime;
            console.log(`Position d√©finie √† ${targetTime}s`);
            
            setTimeout(() => {
              if (!isAudioPlaying) {  // ‚úÖ AJOUT : Protection coh√©rente
                isAudioPlaying = true;
                audio.play()
                  .then(() => {
                    console.log("‚úÖ Audio d√©marr√©");
                  })
                  .catch(e => {
                    console.error("‚ùå Erreur:", e);
                    isAudioPlaying = false;  // ‚úÖ Reset en cas d'erreur
                  });
              }
            }, 100);
          }, { once: true });
        } else {
          // Si la source existe d√©j√†, juste ajuster la position et jouer
          if (audio.readyState >= 2) {
            const targetTime = Math.min(data.offset, audio.duration);
            audio.currentTime = targetTime;
            
            if (!isAudioPlaying) {  // ‚úÖ AJOUT : Protection
              isAudioPlaying = true;
              audio.play()
                .then(() => console.log("‚úÖ Audio d√©marr√©"))
                .catch(e => {
                  console.error("‚ùå Erreur:", e);
                  isAudioPlaying = false;  // ‚úÖ Reset
                });
            }
          } else {
            // Attendre que l'audio soit pr√™t
            audio.addEventListener('canplay', () => {
              const targetTime = Math.min(data.offset, audio.duration);
              audio.currentTime = targetTime;
              
              if (!isAudioPlaying) {  // ‚úÖ AJOUT : Protection
                isAudioPlaying = true;
                audio.play()
                  .then(() => console.log("‚úÖ Audio d√©marr√©"))
                  .catch(e => {
                    console.error("‚ùå Erreur:", e);
                    isAudioPlaying = false;  // ‚úÖ Reset
                  });
              }
            }, { once: true });
          }
        }
      }
    })
    .catch(e => {
      console.error("Erreur API:", e);
      // Tenter quand m√™me de jouer si on a une source
      if (audio.src && !isAudioPlaying) {  // ‚úÖ AJOUT : Protection
        isAudioPlaying = true;
        audio.play()
          .then(() => console.log("‚úÖ Audio d√©marr√©"))
          .catch(err => {
            console.error("Erreur lecture:", err);
            isAudioPlaying = false;  // ‚úÖ Reset
          });
      }
    });
}

    // Code pour les participants
    let isBadgeVisible = false;

    function updateParticipantsCount(count) {
  participantsCount.textContent = "6"; // Toujours afficher 6
  if (isBadgeVisible) {
    participantsCount.style.transform = 'scale(1.2)';
    setTimeout(() => {
      participantsCount.style.transform = 'scale(1)';
    }, 200);
  }
}

// Fonction de compte √† rebours pour d√©connexion auto
function startLogoutCountdown() {
  let seconds = 30;
  const countdownElement = document.getElementById('countdown');
  
  const interval = setInterval(() => {
    seconds--;
    if (countdownElement) {
      countdownElement.textContent = seconds;
    }
    
    if (seconds <= 0) {
      clearInterval(interval);
      forceLogoutAfterCourse();
    }
  }, 1000);
}

// Fonction pour forcer la d√©connexion en fin de cours
function forceLogoutAfterCourse() {
  console.log("üîí D√©connexion automatique en cours...");
  
  // Enregistrer la d√©connexion
  fetch('/deconnexion-auto', { method: 'POST' })
    .then(() => {
      console.log("‚úÖ D√©connexion enregistr√©e");
    })
    .catch(e => console.error("‚ùå Erreur d√©connexion:", e))
    .finally(() => {
      // Rediriger vers la page de d√©connexion
      window.location.href = '/logout';
    });
}

// Afficher l'indicateur "Alain √©crit..." - Version align√©e √† gauche
function showTypingIndicator() {
  hideTypingIndicator();
  
  const typingDiv = document.createElement('div');
  typingDiv.id = 'typing-indicator';
  // ‚Üê CHANGEMENT ICI : items-start self-start (align√© √† gauche comme le prof)
  typingDiv.className = 'flex items-start self-start max-w-[85%] animate-fade-in';
  typingDiv.innerHTML = `
    <div class="typing-indicator">
      <div class="flex items-center gap-2">
        <div class="professor-avatar">P</div>
        <span class="text-xs text-gray-300 font-medium"></span>
        <div class="typing-dots">
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
          <div class="typing-dot"></div>
        </div>
      </div>
    </div>
  `;
  
  messagesDiv.appendChild(typingDiv);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Supprimer l'indicateur de frappe
function hideTypingIndicator() {
  const typingIndicator = document.getElementById('typing-indicator');
  if (typingIndicator) {
    typingIndicator.remove();
  }
}

    participantsContainer.addEventListener("click", () => {
      isBadgeVisible = !isBadgeVisible;
      
      if (isBadgeVisible) {
        participantsCount.classList.remove('hidden');
        participantsCount.style.transform = 'scale(0)';
        setTimeout(() => {
          participantsCount.style.transform = 'scale(1)';
        }, 10);
      } else {
        participantsCount.style.transform = 'scale(0)';
        setTimeout(() => {
          participantsCount.classList.add('hidden');
          participantsCount.style.transform = 'scale(1)';
        }, 200);
      }
    });

    // √âcouter le signal de d√©connexion forc√©e (√† ajouter avec les autres socket.on)
socket.on('force_logout', (data) => {
  console.log("üîí D√©connexion forc√©e re√ßue:", data.message);
  
  // Afficher une notification
  const notification = document.createElement('div');
  notification.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white p-6 rounded-lg z-[10000] text-center shadow-2xl border-2 border-red-400';
  notification.innerHTML = `
    <div class="text-xl font-bold mb-2">üîí Formation termin√©e</div>
    <div class="text-sm">${data.message}</div>
    <div class="text-xs mt-2 opacity-80">Redirection automatique...</div>
  `;
  
  document.body.appendChild(notification);
  
  // Rediriger apr√®s 2 secondes
  setTimeout(() => {
    window.location.href = data.redirect_url || '/logout';
  }, 2000);
});

    socket.on('participants_update', (data) => {
      participantsOnline = data.count;
      updateParticipantsCount(participantsOnline);
    });

    socket.on('user_disconnected', (data) => {
      if (data.username && data.username !== username) {
        const isChatOpen = !chat.classList.contains("translate-x-full");
        if (isChatOpen) {
          addMessage('Syst√®me', `${data.username} a quitt√© la session`, new Date().toLocaleTimeString());
        }
      }
    });

    // Emp√™che la d√©connexion "fant√¥me"
    let isReload = false;
    window.addEventListener("pageshow", (event) => {
      if (event.persisted || performance.navigation.type === 1) isReload = true;
      if (event.persisted || performance.navigation.type === 2) window.location.href = "/logout";
    });
    
    window.addEventListener("beforeunload", () => {
      if (!isReload) navigator.sendBeacon("/deconnexion-auto");
      if (syncInterval) {
        clearInterval(syncInterval);
      }
    });

    window.addEventListener("beforeunload", () => {
      if (syncInterval) {
        clearInterval(syncInterval);
      }
    });

    // ===== SYST√àME DE D√âCONNEXION AUTOMATIQUE =====

// Fonction de compte √† rebours pour d√©connexion auto
function startLogoutCountdown() {
  let seconds = 30;
  const countdownElement = document.getElementById('countdown');
  
  const interval = setInterval(() => {
    seconds--;
    if (countdownElement) {
      countdownElement.textContent = seconds;
    }
    
    if (seconds <= 0) {
      clearInterval(interval);
      forceLogoutAfterCourse();
    }
  }, 1000);
}

// Fonction pour forcer la d√©connexion en fin de cours
function forceLogoutAfterCourse() {
  console.log("üîí D√©connexion automatique en cours...");
  
  // Enregistrer la d√©connexion
  fetch('/deconnexion-auto', { method: 'POST' })
    .then(() => {
      console.log("‚úÖ D√©connexion enregistr√©e");
    })
    .catch(e => console.error("‚ùå Erreur d√©connexion:", e))
    .finally(() => {
      // Rediriger vers la page de d√©connexion
      window.location.href = '/logout';
    });
}

// √âcouter le signal de d√©connexion forc√©e par admin
socket.on('force_logout', (data) => {
  console.log("üîí D√©connexion forc√©e re√ßue:", data.message);
  
  // Cr√©er notification visuelle
  const notification = document.createElement('div');
  notification.className = `
    fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
    bg-red-600 text-white p-6 rounded-lg z-[10000] text-center 
    shadow-2xl border-2 border-red-400 min-w-[300px]
  `;
  notification.innerHTML = `
    <div class="text-xl font-bold mb-2">üîí Formation termin√©e</div>
    <div class="text-sm">${data.message}</div>
    <div class="text-xs mt-2 opacity-80">Redirection automatique...</div>
  `;
  
  document.body.appendChild(notification);
  
  // Rediriger apr√®s 2 secondes
  setTimeout(() => {
    window.location.href = data.redirect_url || '/logout';
  }, 2000);
});

  </script>

</body>
</html>